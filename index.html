<!DOCTYPE html>
<html>
<head>
    <title>Moho ʻĀina Lookup</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Google Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAtco2uFcMtIeKWGoHJE9KVrEk98H3wUtM&libraries=places"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #search-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: all 0.5s ease;
            text-align: center;
        }
        
        #search-container.minimized {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px;
        }
        
        #search-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            transition: all 0.5s ease;
        }
        
        #search-container.minimized #search-title {
            display: none;
        }
        
        #address-input {
            width: 500px;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #333;
            border-radius: 4px;
            transition: all 0.5s ease;
        }
        
        #search-container.minimized #address-input {
            width: 300px;
            padding: 10px;
            font-size: 16px;
        }
        
        #search-button {
            padding: 15px 30px;
            font-size: 18px;
            background: #3388ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.5s ease;
        }
        
        #search-container.minimized #search-button {
            padding: 10px 20px;
            font-size: 16px;
            margin-left: 5px;
        }
        
        #search-button:hover {
            background: #2266cc;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            background: #e0e0e0;
            border-radius: 10px;
            padding: 15px;
        }
        
        .popup-content {
            width: 320px;
            font-family: Arial, sans-serif;
        }
        
        .popup-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .rep-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .rep-oval {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid;
            background-size: cover;
            background-position: center;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="35" r="20" fill="%23999"/><path d="M 20 100 Q 20 70 50 70 Q 80 70 80 100 Z" fill="%23999"/></svg>');
            flex-shrink: 0;
        }
        
        .has-moho {
            border-color: #28a745;
        }
        
        .no-moho {
            border-color: #dc3545;
        }
        
        .rep-info {
            margin-left: 15px;
            flex-grow: 1;
        }
        
        .rep-office {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 3px;
        }
        
        .rep-name {
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>

<div id="search-container">
    <div id="search-title">Find Your Moho ʻĀina</div>
    <div style="position: relative;">
        <input type="text" id="address-input" placeholder="Enter your Hawaii address...">
        <button id="search-button">Search</button>
    </div>
</div>

<div id="map"></div>

<script>
    // ============ CONFIGURATION ============
    
    // Google Sheets published CSV URLs
    const SHEET_URLS = {
        senate: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQziAtuCEyrfaYovfFOfKlKqETRvXGe0fwmiaXuV0xhIZC-8rcLD8SYbsZyB911yVkvepLvdYCRm-At/pub?gid=1358067559&single=true&output=csv',
        house: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQziAtuCEyrfaYovfFOfKlKqETRvXGe0fwmiaXuV0xhIZC-8rcLD8SYbsZyB911yVkvepLvdYCRm-At/pub?gid=0&single=true&output=csv',
        hawaii: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQziAtuCEyrfaYovfFOfKlKqETRvXGe0fwmiaXuV0xhIZC-8rcLD8SYbsZyB911yVkvepLvdYCRm-At/pub?gid=1643797979&single=true&output=csv',
        maui: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQziAtuCEyrfaYovfFOfKlKqETRvXGe0fwmiaXuV0xhIZC-8rcLD8SYbsZyB911yVkvepLvdYCRm-At/pub?gid=1505508928&single=true&output=csv',
        honolulu: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQziAtuCEyrfaYovfFOfKlKqETRvXGe0fwmiaXuV0xhIZC-8rcLD8SYbsZyB911yVkvepLvdYCRm-At/pub?gid=978802498&single=true&output=csv',
        kauai: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQziAtuCEyrfaYovfFOfKlKqETRvXGe0fwmiaXuV0xhIZC-8rcLD8SYbsZyB911yVkvepLvdYCRm-At/pub?gid=913383944&single=true&output=csv'
    };
    
    // ============ GLOBAL VARIABLES ============
    
    let map;
    let geoJsonLayers = {
        county: [],
        house: null,
        senate: null
    };
    let sheetData = {};
    let currentMarker = null;
    let hasSearched = false;
    
    // ============ INITIALIZE MAP ============
    
    function initMap() {
        const hawaiiCenter = [20.7984, -156.3319];
        map = L.map('map').setView(hawaiiCenter, 8);
        
        const satelliteLayer = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
        L.tileLayer(satelliteLayer, { 
            attribution: 'Tiles &copy; Esri',
            maxZoom: 18 
        }).addTo(map);
    }
    
    // ============ UTILITY FUNCTIONS ============
    
    function trimLeadingZeros(str) {
        if (!str) return str;
        return String(str).replace(/^0+/, '') || '0';
    }
    
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const data = {};
        
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            const id = trimLeadingZeros(values[0]);
            data[id] = {
                name: values[1] || '',
                mohoAina: values[2] || ''
            };
        }
        
        return data;
    }
    
    // ============ GOOGLE PLACES AUTOCOMPLETE ============
    
    let autocomplete;
    
    function initAutocomplete() {
        const input = document.getElementById('address-input');
        
        try {
            console.log('Initializing Google Places Autocomplete...');
            
            // Create autocomplete object restricted to Hawaii
            autocomplete = new google.maps.places.Autocomplete(input, {
                componentRestrictions: { country: 'us' },
                bounds: new google.maps.LatLngBounds(
                    new google.maps.LatLng(18.5, -160.5), // Southwest corner
                    new google.maps.LatLng(22.5, -154.5)  // Northeast corner
                ),
                strictBounds: false,  // Changed to false - strict might be too restrictive
                fields: ['geometry', 'formatted_address']
            });
            
            console.log('Autocomplete initialized successfully');
            
            // Listen for place selection
            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                
                console.log('Place changed:', place);
                
                if (!place.geometry || !place.geometry.location) {
                    console.log('No geometry for place');
                    return;
                }
                
                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();
                
                console.log('Place selected:', place.formatted_address, lat, lng);
                handleSearch(lat, lng);
            });
            
            // Add error listener
            google.maps.event.addDomListener(input, 'error', function(error) {
                console.error('Google Places error:', error);
            });
            
        } catch (error) {
            console.error('Error initializing autocomplete:', error);
            alert('Error loading address autocomplete. You can still search by clicking the Search button.');
        }
    }
    
    // ============ LOAD GOOGLE SHEETS DATA ============
    
    async function loadSheetData() {
        try {
            const promises = Object.entries(SHEET_URLS).map(async ([key, url]) => {
                const response = await fetch(url);
                const text = await response.text();
                sheetData[key] = parseCSV(text);
            });
            
            await Promise.all(promises);
            console.log('Sheet data loaded:', sheetData);
        } catch (error) {
            console.error('Error loading sheet data:', error);
        }
    }
    
    // ============ LOAD GEOJSON LAYERS ============
    
    async function loadGeoJsonLayers() {
        // Load county layers
        const countyFiles = [
            { file: 'Hawaii County.geojson', county: 'hawaii' },
            { file: 'Maui County.geojson', county: 'maui' },
            { file: 'Honolulu County.geojson', county: 'honolulu' },
            { file: 'Kauai County.geojson', county: 'kauai' }
        ];
        
        for (const {file, county} of countyFiles) {
            try {
                const response = await fetch(file);
                const data = await response.json();
                const layer = L.geoJSON(data, {
                    style: { fillOpacity: 0, color: '#333', weight: 1 }
                });
                geoJsonLayers.county.push({ layer, data, county });
            } catch (error) {
                console.error(`Error loading ${file}:`, error);
            }
        }
        
        // Load House
        try {
            const response = await fetch('House.geojson');
            const data = await response.json();
            geoJsonLayers.house = {
                layer: L.geoJSON(data, { style: { fillOpacity: 0, color: '#333', weight: 1 } }),
                data
            };
        } catch (error) {
            console.error('Error loading House:', error);
        }
        
        // Load Senate
        try {
            const response = await fetch('Senate.geojson');
            const data = await response.json();
            geoJsonLayers.senate = {
                layer: L.geoJSON(data, { style: { fillOpacity: 0, color: '#333', weight: 1 } }),
                data
            };
        } catch (error) {
            console.error('Error loading Senate:', error);
        }
    }
    
    // ============ FIND DISTRICT BY POINT ============
    
    function findDistrictByPoint(latlng, geoJsonData, idField, county = null) {
        const point = [latlng.lng, latlng.lat];
        
        for (const feature of geoJsonData.features) {
            if (leafletPip.pointInLayer(point, L.geoJSON(feature), true).length > 0) {
                let districtId = feature.properties[idField];
                
                // Special handling for Maui County
                if (county === 'maui' && idField === 'objectid') {
                    districtId = feature.properties['districtnu'];
                }
                
                districtId = trimLeadingZeros(String(districtId));
                return { districtId, feature };
            }
        }
        
        return null;
    }
    
    // ============ CREATE POPUP CONTENT ============
    
    function createPopupContent(countyInfo, houseInfo, senateInfo) {
        const rows = [
            {
                office: 'County Council',
                data: countyInfo
            },
            {
                office: 'State House',
                data: houseInfo
            },
            {
                office: 'State Senate',
                data: senateInfo
            }
        ];
        
        let html = '<div class="popup-content">';
        html += '<div class="popup-title">Your Representatives</div>';
        
        for (const row of rows) {
            const hasMoho = row.data && row.data.mohoAina;
            const mohoClass = hasMoho ? 'has-moho' : 'no-moho';
            const name = hasMoho ? row.data.mohoAina : '';
            
            html += `
                <div class="rep-row">
                    <div class="rep-oval ${mohoClass}"></div>
                    <div class="rep-info">
                        <div class="rep-office">${row.office}</div>
                        <div class="rep-name">${name}</div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    // ============ GEOCODE AND SEARCH ============
    
    async function geocodeAddress(address) {
        // Check if Google Maps is available
        if (typeof google === 'undefined' || !google.maps) {
            alert('Google Maps is not loaded. Please refresh the page and try again.');
            return null;
        }
        
        return new Promise((resolve, reject) => {
            const geocoder = new google.maps.Geocoder();
            
            geocoder.geocode(
                { 
                    address: address + ', Hawaii, USA',
                    componentRestrictions: { country: 'US' },
                    bounds: new google.maps.LatLngBounds(
                        new google.maps.LatLng(18.5, -160.5),
                        new google.maps.LatLng(22.5, -154.5)
                    )
                },
                (results, status) => {
                    console.log('Geocoding status:', status);
                    console.log('Geocoding results:', results);
                    
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng()
                        });
                    } else if (status === 'OVER_QUERY_LIMIT') {
                        alert('Too many requests. Please wait a moment and try again.');
                        resolve(null);
                    } else if (status === 'REQUEST_DENIED') {
                        alert('Geocoding request denied. There may be an issue with the API key.');
                        console.error('Geocoding denied - check API key restrictions');
                        resolve(null);
                    } else {
                        alert('Address not found. Please try a different address.');
                        resolve(null);
                    }
                }
            );
        });
    }
    
    async function handleSearch(providedLat = null, providedLng = null) {
        console.log('handleSearch called with:', providedLat, providedLng);
        
        let coords;
        
        if (providedLat && providedLng) {
            // From autocomplete
            coords = { lat: parseFloat(providedLat), lng: parseFloat(providedLng) };
            console.log('Using autocomplete coords:', coords);
        } else {
            // From search button
            const address = document.getElementById('address-input').value.trim();
            
            if (!address) {
                alert('Please enter an address');
                return;
            }
            
            console.log('Geocoding address:', address);
            coords = await geocodeAddress(address);
            if (!coords) return;
            console.log('Geocoded to:', coords);
        }
        
        const latlng = L.latLng(coords.lat, coords.lng);
        console.log('LatLng object:', latlng);
        
        // Minimize search bar after first search
        if (!hasSearched) {
            document.getElementById('search-container').classList.add('minimized');
            hasSearched = true;
        }
        
        // Zoom to location (neighborhood level = zoom 14-15)
        map.setView(latlng, 14);
        
        // Remove old marker if exists
        if (currentMarker) {
            map.removeLayer(currentMarker);
        }
        
        // Find districts
        let countyInfo = null;
        let countyName = null;
        
        console.log('Checking county districts...');
        // Check which county
        for (const {layer, data, county} of geoJsonLayers.county) {
            const idField = county === 'maui' ? 'districtnu' : 'objectid';
            const result = findDistrictByPoint(latlng, data, idField, county);
            
            if (result) {
                console.log('Found county:', county, 'District:', result.districtId);
                countyName = county;
                const districtData = sheetData[county]?.[result.districtId];
                countyInfo = districtData || { mohoAina: '' };
                break;
            }
        }
        
        // Check House
        let houseInfo = null;
        console.log('Checking house districts...');
        if (geoJsonLayers.house) {
            const result = findDistrictByPoint(latlng, geoJsonLayers.house.data, 'SLDST');
            if (result) {
                console.log('Found house district:', result.districtId);
                houseInfo = sheetData.house?.[result.districtId] || { mohoAina: '' };
            }
        }
        
        // Check Senate
        let senateInfo = null;
        console.log('Checking senate districts...');
        if (geoJsonLayers.senate) {
            const result = findDistrictByPoint(latlng, geoJsonLayers.senate.data, 'SLDUST');
            if (result) {
                console.log('Found senate district:', result.districtId);
                senateInfo = sheetData.senate?.[result.districtId] || { mohoAina: '' };
            }
        }
        
        console.log('District results:', { countyInfo, houseInfo, senateInfo });
        
        // Create popup
        const popupContent = createPopupContent(countyInfo, houseInfo, senateInfo);
        
        // Add marker with popup
        currentMarker = L.marker(latlng).addTo(map);
        currentMarker.bindPopup(popupContent, {
            className: 'custom-popup',
            maxWidth: 400
        }).openPopup();
    }
    
    // ============ POINT IN POLYGON LIBRARY ============
    
    const leafletPip = {
        pointInLayer: function(point, layer, first) {
            const results = [];
            layer.eachLayer(function(l) {
                if (l.feature && l.feature.geometry) {
                    if (leafletPip.pointInPolygon(point, l.feature.geometry)) {
                        results.push(l);
                        if (first) return results;
                    }
                }
            });
            return results;
        },
        
        pointInPolygon: function(point, geometry) {
            if (geometry.type === 'Polygon') {
                return leafletPip.pointInRing(point, geometry.coordinates[0]);
            } else if (geometry.type === 'MultiPolygon') {
                for (const polygon of geometry.coordinates) {
                    if (leafletPip.pointInRing(point, polygon[0])) {
                        return true;
                    }
                }
            }
            return false;
        },
        
        pointInRing: function(point, ring) {
            let inside = false;
            const x = point[0], y = point[1];
            
            for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
                const xi = ring[i][0], yi = ring[i][1];
                const xj = ring[j][0], yj = ring[j][1];
                
                const intersect = ((yi > y) !== (yj > y)) &&
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                
                if (intersect) inside = !inside;
            }
            
            return inside;
        }
    };
    
    // ============ INITIALIZE ============
    
    async function init() {
        console.log('Initializing map...');
        
        // Check if Google Maps loaded
        if (typeof google === 'undefined' || !google.maps) {
            console.error('Google Maps failed to load!');
            alert('Google Maps failed to load. Address autocomplete will not work, but you can still use the Search button.');
        } else {
            console.log('Google Maps loaded successfully');
        }
        
        // Initialize the Leaflet map
        initMap();
        
        await Promise.all([
            loadSheetData(),
            loadGeoJsonLayers()
        ]);
        
        // Initialize Google Places Autocomplete if Google Maps loaded
        if (typeof google !== 'undefined' && google.maps) {
            initAutocomplete();
        }
        
        // Set up event listeners
        document.getElementById('search-button').addEventListener('click', () => handleSearch());
        
        document.getElementById('address-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        
        console.log('Map ready!');
    }
    
    // Wait for window to load before initializing
    window.addEventListener('load', function() {
        console.log('Window loaded, starting init...');
        init();
    });
    
</script>

</body>
</html>
